<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>
RossW.co.uk | articles in the "Linux" category    </title>
    <link rel="shortcut icon" type="image/png" href="https://rossw.co.uk/favicon.png">
    <link rel="shortcut icon" type="image/x-icon" href="https://rossw.co.uk/favicon.ico">
    <link href="https://rossw.co.uk/feeds/all.rss.xml" type="application/rss+xml" rel="alternate" title="RossW.co.uk Full RSS Feed" />
    <link rel="stylesheet" href="https://rossw.co.uk/theme/css/main.css" type="text/css" />
    <link rel="stylesheet" href="https://rossw.co.uk/theme/css/pygments.css" type="text/css" />
    <meta name="generator" content="Pelican" />
    <meta name="author" content="Ross" />

<meta name="description" content="Learn with me. Programming, DevOps, Homelabs & more" />
</head>
<body>
    <header>
        <nav>
            <ul>

                <li class="ephemeral selected"><a href="https://rossw.co.uk/category/linux.html">Linux</a></li>
                <li><a href="https://rossw.co.uk/">Home</a></li>
                <li><a href="https://rossw.co.uk/pages/about.html">About</a></li>
                <li><a href="https://rossw.co.uk/archive">Archives</a></li>
            </ul>
        </nav>
        <div class="header_box">
            <h1><a href="https://rossw.co.uk/">RossW.co.uk</a></h1>
            <h2>Programming, DevOps, Homelabs & more</h2>
        </div>
    </header>
    <div id="wrapper">
        <div id="content">            <h4 class="date">Apr 10, 2021</h4>

            <article class="post">
                <h2 class="title">
                    <a href="https://rossw.co.uk/home-to-zfs.html" rel="bookmark" title="Permanent Link to &quot;Giving /home a new home on ZFS&quot;">Giving /home a new home on ZFS</a>
                </h2>

                
                

                <p>Currently on my main desktop machine my <code>/home</code> directory resides on it's own 256gb SSD with an ext4 filesystem. I want to move this to a ZFS file system to take advantage of snapshots and compression.</p>
<p>I have a TrueNAS VM running in proxmox (more on this in future posts) that <code>/home</code> then gets backed up to using an <code>rsync</code> cronjob. However as I mentioned previously I would like to be able to take advantage of ZFS snapshots when doing backups so I have decided to move <code>/home</code> to ZFS. 
I run ubuntu 20.10 on my desktop PC so this is fairly straight forward. ZFS is supported out of the box in the kernel on ubuntu. </p>
<p>The only aspect that makes this a little bit messy is that I want to use ZFS on the existing SSD that currently has <code>/home</code> on it. I'll need to do quite a bit of juggling files!</p>
<p>I am going to performing these steps on the live filesystem. I would recommend using a LiveCD for performing these tasks where possible, it'll make it a bit easier.</p>
<h3>Install ZFS tools</h3>
<p>First of all, let's install the tools required for managing zfs using apt.</p>
<div class="highlight"><pre><span></span><code>sudo apt install zfsutils-linux
</code></pre></div>

<h3>Copy /home to a temporary location</h3>
<p>The next thing to do is copy the entire contents of the <code>/home</code> directory that currently resides on the SSD to a temporary location. I have plenty of space on my main drive so I'm just going to create a folder there and copy everything to it but if you don't then feel free to use an external drive.</p>
<div class="highlight"><pre><span></span><code>sudo mkdir /temp-hone
sudo cp -av /home/* /temp-home/
</code></pre></div>

<p>Using the <code>-a</code> flag with <code>cp</code> preserves all file attributes and copies recursively so there shouldn't be any strange file permission issues.</p>
<h3>Edit fstab and un-mount the drive</h3>
<p>Now that the <code>/home</code> directory has been safely copied to another location <code>fstab</code> can be edited to stop the partition being mounted at boot. For now we can simply comment out the relevant line incase something goes wrong and we need to revert this step.</p>
<div class="highlight"><pre><span></span><code>sudo vim /etc/fstab

# /home was on /dev/sda1 during installation
# UUID=myuuid /home           ext4    defaults
</code></pre></div>

<p>Next we can un-mount the drive. We use the <code>-lf</code> flags for force and lazy un-mounting. Without this it won't work as there are programs running that are actively trying to access this file system. As I mentioned in the introduction, doing this in a live filesystem is less than ideal, which is why we had to take this step.</p>
<div class="highlight"><pre><span></span><code>sudo umount -lf /dev/sda1
</code></pre></div>

<h3>Copy /temp-home back to /home</h3>
<p>Due to doing this live and having plenty of drive space we are going to copy the <code>/temp-home/</code> to <code>/home</code> so that when we reboot everything is where ubuntu suspects it to be, this now resides on the main OS drive.
A reboot is required because the <code>home</code> drive was unmounted lazily and we need to be able to delete the partition(s) so that ZFS can do it's thing! </p>
<div class="highlight"><pre><span></span><code>sudo cp -a /temp-home/* /home/
reboot
</code></pre></div>

<p>The system should come back up as if nothing has changed.</p>
<h3>Use fdisk to delete partition</h3>
<p>Before we can create the ZFS pool we need to delete all partitions from the second SSD, which is <code>/dev/sda</code>. For this we can use <code>fdisk</code>.</p>
<div class="highlight"><pre><span></span><code>$ sudo fdisk /dev/sda

Welcome to fdisk (util-linux 2.36).
Changes will remain in memory only, until you decide to write them.
Be careful before using the write command.


Command (m for help): d
Selected partition 1
Partition 1 has been deleted.

Command (m for help): w

The partition table has been altered.
Calling ioctl() to re-read partition table.
Synching disks.
</code></pre></div>

<p>Using <code>d</code> to delete the partition as there was only one and then <code>w</code> to write the changes to the partition table.</p>
<h3>Create a ZFS pool</h3>
<p>The preparation is done so now we can finally create the ZFS pool. I'm going with <code>mypool</code> for lack of a better name but feel free to choose whatever you like. I also only have the one drive so don't need to worry about any sort of RAIDZ or mirroring. If you have multiple drives you'd like in your pool you'll want to check out the manpages for <code>zpool create</code>.</p>
<div class="highlight"><pre><span></span><code>sudo zpool create mypool /dev/sda
</code></pre></div>

<p>Then just a quick <code>zpool status</code> to check it was created.</p>
<div class="highlight"><pre><span></span><code>$ sudo zpool status
pool: mypool
state: ONLINE
scan: none requested
config:

    NAME        STATE     READ WRITE CKSUM
    mypool      ONLINE       0     0     0
    sda         ONLINE       0     0     0

errors: No known data errors
</code></pre></div>

<h3>Create the ZFS filesystem</h3>
<p>Next create the <code>home</code> filesystem in the pool.</p>
<div class="highlight"><pre><span></span><code>sudo zfs create mypool/home
</code></pre></div>

<p>And check it was created.</p>
<div class="highlight"><pre><span></span><code>sudo zfs list
NAME          USED  AVAIL     REFER  MOUNTPOINT
mypool        984K   225G      192K  /mypool
mypool/home   192K   225G      192K  /mypool/home
</code></pre></div>

<h3>Enable Compression</h3>
<p>Another benefit of ZFS is being able to use compression, there is a slight performance hit for doing this but since it's just my home directory I don't see this causing me any issues. So let's enable that now.</p>
<div class="highlight"><pre><span></span><code>sudo zfs set compression=lz4 mypool
</code></pre></div>

<p>I'm going to go with lz4 since this gives a great compression ratio for minimal performance impact. ServeTheHome have a great <a href="https://www.servethehome.com/the-case-for-using-zfs-compression/">article</a> about it. </p>
<h3>Copy /temp-home to it's new home</h3>
<p>Great! Now that we have the filesystem and it is mounted at <code>/mypool/home</code> we can copy all the contents of the <code>/temp-home/</code> directory to it once again using the <code>cp -a</code> command.</p>
<div class="highlight"><pre><span></span><code>sudo cp -av /temp-home/* /mypool/home
</code></pre></div>

<p>Then check the pool usage and compression ratio.</p>
<div class="highlight"><pre><span></span><code>$ sudo zfs list -o name,used,avail,refer,mountpoint,compressratio
NAME          USED  AVAIL     REFER  MOUNTPOINT     RATIO
mypool       54.9G   170G      192K  /mypool        1.22x
mypool/home  54.9G   170G     54.9G  /mypool/home   1.22x
</code></pre></div>

<p>And yep, we can now see that 54.9G is used up and the compression ratio is 1.22x. Compression has definitely paid off!</p>
<h3>Delete everything in /home and mount the ZFS filesystem</h3>
<p>Now to clean up and get the ZFS filesystem mounted at <code>/home</code>.</p>
<p>Delete the <code>/home</code> directory.</p>
<div class="highlight"><pre><span></span><code>sudo rm -rf /home
</code></pre></div>

<p>Then change the mountpoint of <code>mypool/home</code> to <code>/home</code>. And while we are it we can stop <code>mypool</code> from mounting by setting it's mountpoint to <code>none</code></p>
<div class="highlight"><pre><span></span><code>sudo zfs set mountpoint=/home mypool/home
sudo zfs set mountpoint=none mypool
</code></pre></div>

<p>Check that the files are there in <code>/home</code>.</p>
<div class="highlight"><pre><span></span><code>$ ll /home
total 22
drwxr-xr-x  4 root root    4 Apr  6 12:40 ./
drwxr-xr-x 24 root root 4096 Apr  6 12:46 ../
drwx------  2 root root    2 Mar  4 17:42 lost+found/
drwxr-xr-x 46 ross ross   72 Apr  6 13:57 ross/
</code></pre></div>

<p>Awesome! Everything is there and now on a ZFS filesystem.</p>
<h3>Reboot</h3>
<p>Finally a quick reboot to make sure it mounts correctly on boot, there's no reason it shouldn't but better to be safe than sorry.</p>
<div class="highlight"><pre><span></span><code>sudo reboot
</code></pre></div>

<p>And everything is there as expected. Success!</p>
<div class="highlight"><pre><span></span><code>$ ll /home
total 22
drwxr-xr-x  4 root root    4 Apr  6 12:40 ./
drwxr-xr-x 24 root root 4096 Apr  6 12:46 ../
drwx------  2 root root    2 Mar  4 17:42 lost+found/
drwxr-xr-x 46 ross ross   72 Apr  6 13:57 ross/
</code></pre></div>

<h3>Summary</h3>
<p>This process would have been a bit less painful if I'd use a LiveCD environment as I wouldn't have to have copies of copies of my home directory but overall it seems to have gone well.</p>
<p>I'm going to keep <code>/temp-home</code> around for a week or so just incase something goes wrong but once I'm happy everything is okay that will be deleted.</p>
<p>The next steps are to learn more about ZFS snapshots and replication so that I can start using these for my backups. I'm pretty new to ZFS and this is the first time I've created pools and file systems in this manor, my only previous experience was in TrueNAS which gives a nice web UI interface for performing all these tasks.</p>
<p>I've heard great things about <a href="https://github.com/jimsalterjrs/sanoid">sanoid</a> so I'm probably going to go with that for my snapshot and backup solution. I'll of course write a blog post about it but for now I'm just going to keep my <code>rsync</code> cronjob around for backups.</p>
<p>If you have any questions or suggestions for using ZFS please get in touch. Contact details be found <a href="https://rossw.co.uk/pages/about.html">here</a>.</p>
                <section>
                <p id="post-share-links">
                    Share on:
                    <a href="https://twitter.com/intent/tweet?text=Giving%20/home%20a%20new%20home%20on%20ZFS&url=https%3A//rossw.co.uk/home-to-zfs.html&hashtags=zfs,linux,ubuntu,sysadmin" title="Share on Twitter">Twitter</a>
                    ·
                    <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A//rossw.co.uk/home-to-zfs.html" title="Share on Facebook">Facebook</a>
                    ·
                    <a href="https://www.reddit.com/submit?url=https%3A//rossw.co.uk/home-to-zfs.html&title=Giving%20/home%20a%20new%20home%20on%20ZFS" title="Share via Reddit">Reddit</a>
                    ·
                    <a href="mailto:?subject=Giving%20/home%20a%20new%20home%20on%20ZFS&amp;body=https%3A//rossw.co.uk/home-to-zfs.html" title="Share via Email">Email</a>
                </p>
                </section>
                <div class="clear"></div>

                <div class="info">
                    <a href="https://rossw.co.uk/home-to-zfs.html">posted at 10:00</a>
                    &nbsp;&middot;&nbsp;<a href="https://rossw.co.uk/category/linux.html" rel="tag">Linux</a>
                    &nbsp;&middot;
                    &nbsp;<a href="https://rossw.co.uk/tag/zfs.html" class="tags">zfs</a>
                    &nbsp;<a href="https://rossw.co.uk/tag/linux.html" class="tags">linux</a>
                    &nbsp;<a href="https://rossw.co.uk/tag/ubuntu.html" class="tags">ubuntu</a>
                    &nbsp;<a href="https://rossw.co.uk/tag/sysadmin.html" class="tags">sysadmin</a>
                </div>
            </article>

            <div class="clear"></div>
            <footer>
                <p>
                <a href="https://github.com/rosswf"><img src="https://rossw.co.uk/theme/images/GitHub-Mark-32px.webp" alt="My Github" width="32" height="32"></a>
                <a href="https://twitter.com/rossw_"><img src="https://rossw.co.uk/theme/images/2021-Twitter-logo-black.webp" alt="My Twitter" width="32" height="26"></a>
                </p>
                <p>
                Modified <a href="https://github.com/jody-frankowski/blue-penguin">Blue Penguin</a> Theme
                &middot;
                Powered by <a href="http://getpelican.com">Pelican</a>
                &middot;
                <a href="https://rossw.co.uk/feeds/all.rss.xml" rel="alternate">Rss Feed</a>
            </footer>
        </div>
        <div class="clear"></div>
    </div>
    <a href="https://github.com/rosswf" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#15A9DB; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>
</body>
</html>
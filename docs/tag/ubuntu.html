<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>
RossW.co.uk | articles tagged "ubuntu"    </title>
    <link rel="shortcut icon" type="image/png" href="https://rossw.co.uk/favicon.png">
    <link rel="shortcut icon" type="image/x-icon" href="https://rossw.co.uk/favicon.ico">
    <link href="https://rossw.co.uk/feeds/all.rss.xml" type="application/rss+xml" rel="alternate" title="RossW.co.uk Full RSS Feed" />
    <link rel="stylesheet" href="https://rossw.co.uk/theme/css/main.css" type="text/css" />
    <link rel="stylesheet" href="https://rossw.co.uk/theme/css/pygments.css" type="text/css" />
    <meta name="generator" content="Pelican" />
    <meta name="author" content="Ross" />

<meta name="description" content="Learn with me. Programming, DevOps, Homelabs & more" />
</head>
<body>
    <header>
        <nav>
            <ul>
                <li class="ephemeral selected"><a href="https://rossw.co.uk/tag/ubuntu.html">ubuntu</a></li>
                <li><a href="https://rossw.co.uk/">Home</a></li>
                <li><a href="https://rossw.co.uk/pages/about.html">About</a></li>
                <li><a href="https://rossw.co.uk/archive">Archives</a></li>
            </ul>
        </nav>
        <div class="header_box">
            <h1><a href="https://rossw.co.uk/">RossW.co.uk</a></h1>
            <h2>Programming, DevOps, Homelabs & more</h2>
        </div>
    </header>
    <div id="wrapper">
        <div id="content">            <h4 class="date">Aug 08, 2021</h4>

            <article class="post">
                <h2 class="title">
                    <a href="https://rossw.co.uk/how-to-setup-an-aws-ec2-vps-instance.html" rel="bookmark" title="Permanent Link to &quot;How to setup an AWS EC2 (VPS) instance&quot;">How to setup an AWS EC2 (VPS) instance</a>
                </h2>

                
                

                <p>Recently, I have seen a number of people looking for hosting for their discord bots. Many people go to services like Heroku, but if you would like full VPS and full control, then AWS is a great option, especially since there is a free tier for one year. However, AWS has a lot of different products and the UI can be a little overwhelming so I thought I would write a quick brief guide on how to get started. This, however, is by no means a deep dive into all the features/products of AWS.</p>
<h3>Getting Started</h3>
<p>The first thing you need to do is head over to <a href="https://aws.amazon.com/">AWS</a> and create an account. This is not the same account that you would use for Amazon's website so you will need to create a new one. Make sure you setup 2FA as well.</p>
<p>Once you have your account and are logged in, head over to the management console and under All Services-&gt;Compute, select EC2. This is basically amazon's name for a VPS, similar to a droplet on DigitalOcean.</p>
<p><em>Note: If you wish to change the region, you can do so in the top right, next to your account name. It would make sense to do this now before creating your EC2 instance.</em></p>
<p><img alt="Management Console" src="https://rossw.co.uk/images/aws-ec2-hosting/management-console.webp"></p>
<h3>Launch instance</h3>
<p>The EC2 Dashboard can seem very overwhelming at first as there are a lot of options, but the only thing we need right now is the big orange "Launch instance" button.</p>
<p><img alt="Launch instance" src="https://rossw.co.uk/images/aws-ec2-hosting/launch-instance.webp"></p>
<p><strong>Step 1: Choose an Amazon Machine Image (AMI)</strong></p>
<p>The first step is selecting which operating system you would like to run on your EC2 instance. Make sure you choose one that is "Free tier eligible" if you want to take advantage of that for 12 months. For the purpose of this guide, I'm going to go with Ubuntu Server 20.04 LTS. If you are new to Linux, it is a great option as there are many learning resources available online; I'd definitely recommend it for getting started.</p>
<p><img alt="Ubuntu Server" src="https://rossw.co.uk/images/aws-ec2-hosting/ubuntu-server.webp"></p>
<p><strong>Step 2: Choose an Instance Type</strong></p>
<p>Next we choose our instance type. There are plenty of options here (everything on AWS seems to be overwhelming!). For getting started, choose the t2.micro as this is free tier eligible and has 1gb of RAM which will be plenty for starting out. You can always upgrade later to one of the other instance types if your needs require it.</p>
<p>Depending on what you are planning to run on your VPS, you can probably now just click the big blue "Review and Launch" button. This would be suitable for anything that doesn't require an inbound connection, such as a discord bot. However, if you want to host a website, see the optional step below.</p>
<p>If you do not require any inbound connection other than SSH, you can skip the next step and just click the "Review and Launch" button.</p>
<p><em>Note: One thing that could be done to restrict access is to change the security group settings so that SSH is only accessible from your own IP address rather than the entire world</em></p>
<p><img alt="Instance Type" src="https://rossw.co.uk/images/aws-ec2-hosting/instance-type.webp"></p>
<p><strong>Optional: Step 6: Configure Security Group</strong></p>
<p>Skip ahead to step 6 of the configuration. This is where you can configure the security group. This is basically the firewall and defines which ports are open and where they can be accessed from. The change mentioned above about restricting SSH to your own IP can be done here. Simply change the Source to your own IP. For example: If your IP address was 1.1.1.1, you would enter "1.1.1.1/32".</p>
<p>Here are some example options that would allow HTTP/HTTPS web traffic and a connection from SSH only on my own IP, shown as 1.1.1.1 as an example. Make sure you replace this with your own.</p>
<p><img alt="Security Group" src="https://rossw.co.uk/images/aws-ec2-hosting/security-group.webp"></p>
<p><strong>Launch!</strong></p>
<p>Once you've completed the steps above, click "Review and Launch".</p>
<p>Make sure you are happy with all your choices, then click "Launch".</p>
<p><strong>SSH Keys</strong></p>
<p>You will now be prompted to create an SSH key pair for accessing the EC2 instance. Choose "Create a new key pair" and give it a name, then click "Download Key Pair". </p>
<p><strong><em>Make sure you save this somewhere secure and not lose it. If you do, you will no longer be able to gain access via SSH.</em></strong></p>
<p><em>Note: I'm not going to go into using SSH and keys as it is outside of the scope of this guide. However, <a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/putty.html">here is a guide</a> for using PuTTY on Windows with the key
pair you have just downloaded.</em></p>
<p>Once you have downloaded the key and saved it somewhere safe, click Launch Instances.</p>
<p><img alt="Key Pair" src="https://rossw.co.uk/images/aws-ec2-hosting/keypair.webp"></p>
<p><strong>Launched!</strong></p>
<p>You can now go back to your dashboard and choose instances on the navigation panel. You should see your instance and its status. Once it is running, we can connect via SSH. You can click on it for further details in the panel below.</p>
<p>To connect, you will need to make note of the Public IPv4 Address. This can be seen in the instance list at the top or within the details tab if you select the instance.</p>
<p><img alt="Launched" src="https://rossw.co.uk/images/aws-ec2-hosting/launched.webp"></p>
<h3>Connecting</h3>
<p>Let's connect by SSH. The default user is <code>ubuntu</code> if you chose Ubuntu Server, and your IP address can be found on the AWS web console as mentioned above</p>
<div class="highlight"><pre><span></span><code>$ ssh ubuntu@3.68.196.247 -i aws-key-pair.pem
</code></pre></div>

<p><img alt="Connected" src="https://rossw.co.uk/images/aws-ec2-hosting/connected.webp"></p>
<p>All connected via SSH!</p>
<h3>Summary</h3>
<p>Hopefully, this guide was easy to follow. AWS is definitely overwhelming at first and there is still a lot I need to learn about it, but as you can see, it's really straight forward to set up with a basic VPS that you can run whatever you need to.</p>
<p>If any of you have any further questions or suggestions, please get in touch! Contact details be found <a href="https://rossw.co.uk/pages/about.html">here</a>.</p>
                <section>
                <p id="post-share-links">
                    Share on:
                    <a href="https://twitter.com/intent/tweet?text=How%20to%20setup%20an%20AWS%20EC2%20%28VPS%29%20instance&url=https%3A//rossw.co.uk/how-to-setup-an-aws-ec2-vps-instance.html&hashtags=aws,hosting,vps,ubuntu" title="Share on Twitter">Twitter</a>
                    ·
                    <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A//rossw.co.uk/how-to-setup-an-aws-ec2-vps-instance.html" title="Share on Facebook">Facebook</a>
                    ·
                    <a href="https://www.reddit.com/submit?url=https%3A//rossw.co.uk/how-to-setup-an-aws-ec2-vps-instance.html&title=How%20to%20setup%20an%20AWS%20EC2%20%28VPS%29%20instance" title="Share via Reddit">Reddit</a>
                    ·
                    <a href="mailto:?subject=How%20to%20setup%20an%20AWS%20EC2%20%28VPS%29%20instance&amp;body=https%3A//rossw.co.uk/how-to-setup-an-aws-ec2-vps-instance.html" title="Share via Email">Email</a>
                </p>
                </section>
                <div class="clear"></div>

                <div class="info">
                    <a href="https://rossw.co.uk/how-to-setup-an-aws-ec2-vps-instance.html">posted at 06:00</a>
                    &nbsp;&middot;&nbsp;<a href="https://rossw.co.uk/category/hosting.html" rel="tag">Hosting</a>
                    &nbsp;&middot;
                    &nbsp;<a href="https://rossw.co.uk/tag/aws.html" class="tags">aws</a>
                    &nbsp;<a href="https://rossw.co.uk/tag/hosting.html" class="tags">hosting</a>
                    &nbsp;<a href="https://rossw.co.uk/tag/vps.html" class="tags">vps</a>
                    &nbsp;<a href="https://rossw.co.uk/tag/ubuntu.html" class="tags selected">ubuntu</a>
                </div>
            </article>            <h4 class="date">Apr 24, 2021</h4>

            <article class="post">
                <h2 class="title">
                    <a href="https://rossw.co.uk/pxeboot-ubuntu-pfsense.html" rel="bookmark" title="Permanent Link to &quot;Netbooting the Ubuntu 21.04 Installer&quot;">Netbooting the Ubuntu 21.04 Installer</a>
                </h2>

                
                

                <p>Ubuntu 21.04 Hirsute Hippo is here! Today I'm going to look at how to use pfSense to boot into the installer over the network. I am going to be installing the Desktop version but the same would apply to the Server version as well.</p>
<p>There are a couple of reasons that I can think of that you might want to do this.</p>
<ol>
<li>If you have a lot of computers you'd like to install on at once, you don't have to have multiple usb drives or CDs.</li>
<li>You misplaced your usb drive that was large enough to fit in the installer on it.</li>
</ol>
<p>I would be doing this because of the second reason... and because it's a fun learning experience.</p>
<p>I have loosely followed the instructions from this <a href="https://discourse.ubuntu.com/t/netbooting-the-live-server-installer/14510">guide</a>.</p>
<h3>Gathering all the files</h3>
<p>There are a few files that we need to get this to work. Two from syslinux and two from the ubuntu ISO itself. We also need to write a short configuration file.</p>
<p>Let's start with syslinux. We need <code>pxelinux.0</code> and <code>ldlinux.c32</code>. The easiest way I find to get these is to download syslinux from <a href="https://mirrors.edge.kernel.org/pub/linux/utils/boot/syslinux/">kernel.org</a> and just extract them.</p>
<div class="highlight"><pre><span></span><code>$ cp bios/core/pxelinux.0 ~/netboot-files/
$ cp bios/com32/elflink/ldlinux/ldlinux.c32 ~/netboot-files/
</code></pre></div>

<p>Now we have those we need <code>initrd</code> and <code>vmlinuz</code> from the Ubuntu 21.04 installer. So let's <a href="https://ubuntu.com/">download</a> it, mount it and grab those files.</p>
<div class="highlight"><pre><span></span><code>$ sudo mkdir /media/iso
$ sudo mount ubuntu-21.04-desktop-amd64.iso /media/iso
$ cp /media/iso/casper/{initrd,vmlinuz} ~/netboot-files/
$ sudo umount /media/iso
</code></pre></div>

<p>Finally we need to create a configuration file for pxelinux.</p>
<div class="highlight"><pre><span></span><code>$ mkdir ~/netboot-files/pxelinux.cfg/
$ touch ~/netboot-files/pxelinux.cfg/default
</code></pre></div>

<p>Then using your favourite text editor put the following into the <code>default</code> file.</p>
<div class="highlight"><pre><span></span><code>DEFAULT install
LABEL install
    KERNEL vmlinuz
    INITRD initrd
    APPEND root=/dev/ram0 ramdisk_size=4000000 ip=dhcp url=https://releases.ubuntu.com/21.04/ubuntu-21.04-desktop-amd64.iso
</code></pre></div>

<p>Here I've set the size of the ramdisk to ~4GB, the thought behind this was that the iso is 2.8GB and we need some room for the actual installation. This might be way too much, I haven't really experimented with it but it works.</p>
<p>This is an extremely basic configuration, you can go quite in depth with pxelinux. There are modules for doing all sorts of things such as creating menus. I'd recommend reading the <a href="https://wiki.syslinux.org/wiki/index.php?title=PXELINUX">wiki</a> for more information.</p>
<p>If you've followed all the steps above you should have:</p>
<div class="highlight"><pre><span></span><code>$ ls -AlR ~/netboot-files
/home/ross/netboot-files:
total 126115
-r--r--r-- 1 ross ross 115774131 Apr 24 14:59 initrd
-rwxrwxr-x 1 ross ross    122308 Apr 24 14:49 ldlinux.c32
-rw-rw-r-- 1 ross ross     46909 Apr 24 14:49 pxelinux.0
drwxrwxr-x 2 ross ross         3 Apr 24 15:02 pxelinux.cfg
-r--r--r-- 1 ross ross  14732384 Apr 24 14:59 vmlinuz

/home/ross/netboot-files/pxelinux.cfg:
total 1
-rw-rw-r-- 1 ross ross 0 Apr 24 15:02 default
</code></pre></div>

<h3>Setting up TFTP in pfSense</h3>
<p>Since pfSense is already acting as the dhcp server it makes it really simple to get everything up and running. The only thing we need is a TFTP server which pfSense has a package for.</p>
<p>This can be done by navigating to System -&gt; Package Manager then going to Available Packages and installing the one called tftpd.</p>
<p>Once this is installed you can navigate to Services-&gt;TFTP Server and check "Enable TFTP service" if it isn't already enabled.</p>
<p><img alt="pfSense tftp settings" src="https://rossw.co.uk/images/pxeboot-ubuntu-pfsense/tftp-settings.webp"></p>
<p>Now we need to get our files from <code>~/netboot-files</code> onto pfSense in the correct location. You can use the webUI to do this by going to the Files section but you can only do one file at time as far as I can tell and it won't handle the folder containing the configuration.</p>
<p>The easiest way is just to use scp.</p>
<div class="highlight"><pre><span></span><code>$ scp -r ~/netboot-files/* admin@192.168.0.1:/tftpboot/
initrd         100%  110MB  93.3MB/s   00:01    
ldlinux.c32    100%  119KB  60.2MB/s   00:00    
pxelinux.0     100%   46KB  46.2MB/s   00:00    
default        100%  185   621.3KB/s   00:00    
vmlinuz        100%   14MB  92.9MB/s   00:00
</code></pre></div>

<h3>pfSense DHCP Configuration</h3>
<p>Now that TFTP is up and running there's some configuration we need to do for the dhcp server to tell enable network booting and point it at our TFTP server.</p>
<p>Navigate to Services-&gt;DHCP Server and scroll all the way down to near the bottom where you should see TFTP and Network Booting options. Click Display Advanced to see all the options.
Check the enable box and then there are just a few fields we need to fill in. 
The IP address for my pfSense is 192.168.0.1 but change your to suit.</p>
<p><img alt="pfSense dhcp settings" src="https://rossw.co.uk/images/pxeboot-ubuntu-pfsense/dhcp-settings.webp"></p>
<h3>Installing Ubuntu!</h3>
<p>That's everything we need to do in pfSense. We should now to be able to boot over the network so let's give it a go.</p>
<p>I'm going to use a virtual box VM for this so I can easily capture the process but it absolutely works on physical hardware but you may have to tweak some BIOS settings since this particular setup is not using UEFI.</p>
<p><img alt="Booting - Part 1" src="https://rossw.co.uk/images/pxeboot-ubuntu-pfsense/booting-1.webp"></p>
<p>It's found our TFP server and is loading the ramdisk.</p>
<p><img alt="Booting - Part 2" src="https://rossw.co.uk/images/pxeboot-ubuntu-pfsense/booting-2.webp"></p>
<p>Downloading of the ISO has started.</p>
<p><img alt="Booting - Part 3" src="https://rossw.co.uk/images/pxeboot-ubuntu-pfsense/booting-3.webp"></p>
<p>And a few minutes later we are in! We can now install Ubuntu 21.04.</p>
<h3>Summary</h3>
<p>pfSense makes this whole process fairly painless with very minimal configuration required thanks to it's plugins. If you are not using pfSense I recommend following the <a href="https://discourse.ubuntu.com/t/netbooting-the-live-server-installer/14510">guide</a> I linked for setting up dhcp and TFTP manually.</p>
<p>These steps are a very minimal configuration and what if we wanted to be able to serve two different distros installers over the network, say we had an LTS for servers and the latest version for any desktops? Well, this should be possible with syslinux/pxelinux and I definitely intend to dive deeper into it in future and explore it's modules. </p>
<p>If any of you have any cool setups for this then get in touch and let me know. Contact details be found <a href="https://rossw.co.uk/pages/about.html">here</a>.</p>
                <section>
                <p id="post-share-links">
                    Share on:
                    <a href="https://twitter.com/intent/tweet?text=Netbooting%20the%20Ubuntu%2021.04%20Installer&url=https%3A//rossw.co.uk/pxeboot-ubuntu-pfsense.html&hashtags=pfsense,tftp,pxe,netboot,ubuntu,hirsute-hippo" title="Share on Twitter">Twitter</a>
                    ·
                    <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A//rossw.co.uk/pxeboot-ubuntu-pfsense.html" title="Share on Facebook">Facebook</a>
                    ·
                    <a href="https://www.reddit.com/submit?url=https%3A//rossw.co.uk/pxeboot-ubuntu-pfsense.html&title=Netbooting%20the%20Ubuntu%2021.04%20Installer" title="Share via Reddit">Reddit</a>
                    ·
                    <a href="mailto:?subject=Netbooting%20the%20Ubuntu%2021.04%20Installer&amp;body=https%3A//rossw.co.uk/pxeboot-ubuntu-pfsense.html" title="Share via Email">Email</a>
                </p>
                </section>
                <div class="clear"></div>

                <div class="info">
                    <a href="https://rossw.co.uk/pxeboot-ubuntu-pfsense.html">posted at 16:30</a>
                    &nbsp;&middot;&nbsp;<a href="https://rossw.co.uk/category/pfsense.html" rel="tag">pfSense</a>
                    &nbsp;&middot;
                    &nbsp;<a href="https://rossw.co.uk/tag/pfsense.html" class="tags">pfsense</a>
                    &nbsp;<a href="https://rossw.co.uk/tag/tftp.html" class="tags">tftp</a>
                    &nbsp;<a href="https://rossw.co.uk/tag/pxe.html" class="tags">pxe</a>
                    &nbsp;<a href="https://rossw.co.uk/tag/netboot.html" class="tags">netboot</a>
                    &nbsp;<a href="https://rossw.co.uk/tag/ubuntu.html" class="tags selected">ubuntu</a>
                    &nbsp;<a href="https://rossw.co.uk/tag/hirsute-hippo.html" class="tags">hirsute hippo</a>
                </div>
            </article>            <h4 class="date">Apr 10, 2021</h4>

            <article class="post">
                <h2 class="title">
                    <a href="https://rossw.co.uk/home-to-zfs.html" rel="bookmark" title="Permanent Link to &quot;Giving /home a new home on ZFS&quot;">Giving /home a new home on ZFS</a>
                </h2>

                
                

                <p>Currently on my main desktop machine my <code>/home</code> directory resides on it's own 256gb SSD with an ext4 filesystem. I want to move this to a ZFS file system to take advantage of snapshots and compression.</p>
<p>I have a TrueNAS VM running in proxmox (more on this in future posts) that <code>/home</code> then gets backed up to using an <code>rsync</code> cronjob. However as I mentioned previously I would like to be able to take advantage of ZFS snapshots when doing backups so I have decided to move <code>/home</code> to ZFS. 
I run ubuntu 20.10 on my desktop PC so this is fairly straight forward. ZFS is supported out of the box in the kernel on ubuntu. </p>
<p>The only aspect that makes this a little bit messy is that I want to use ZFS on the existing SSD that currently has <code>/home</code> on it. I'll need to do quite a bit of juggling files!</p>
<p>I am going to performing these steps on the live filesystem. I would recommend using a LiveCD for performing these tasks where possible, it'll make it a bit easier.</p>
<h3>Install ZFS tools</h3>
<p>First of all, let's install the tools required for managing zfs using apt.</p>
<div class="highlight"><pre><span></span><code>sudo apt install zfsutils-linux
</code></pre></div>

<h3>Copy /home to a temporary location</h3>
<p>The next thing to do is copy the entire contents of the <code>/home</code> directory that currently resides on the SSD to a temporary location. I have plenty of space on my main drive so I'm just going to create a folder there and copy everything to it but if you don't then feel free to use an external drive.</p>
<div class="highlight"><pre><span></span><code>sudo mkdir /temp-hone
sudo cp -av /home/* /temp-home/
</code></pre></div>

<p>Using the <code>-a</code> flag with <code>cp</code> preserves all file attributes and copies recursively so there shouldn't be any strange file permission issues.</p>
<h3>Edit fstab and un-mount the drive</h3>
<p>Now that the <code>/home</code> directory has been safely copied to another location <code>fstab</code> can be edited to stop the partition being mounted at boot. For now we can simply comment out the relevant line incase something goes wrong and we need to revert this step.</p>
<div class="highlight"><pre><span></span><code>sudo vim /etc/fstab

# /home was on /dev/sda1 during installation
# UUID=myuuid /home           ext4    defaults
</code></pre></div>

<p>Next we can un-mount the drive. We use the <code>-lf</code> flags for force and lazy un-mounting. Without this it won't work as there are programs running that are actively trying to access this file system. As I mentioned in the introduction, doing this in a live filesystem is less than ideal, which is why we had to take this step.</p>
<div class="highlight"><pre><span></span><code>sudo umount -lf /dev/sda1
</code></pre></div>

<h3>Copy /temp-home back to /home</h3>
<p>Due to doing this live and having plenty of drive space we are going to copy the <code>/temp-home/</code> to <code>/home</code> so that when we reboot everything is where ubuntu suspects it to be, this now resides on the main OS drive.
A reboot is required because the <code>home</code> drive was unmounted lazily and we need to be able to delete the partition(s) so that ZFS can do it's thing! </p>
<div class="highlight"><pre><span></span><code>sudo cp -a /temp-home/* /home/
reboot
</code></pre></div>

<p>The system should come back up as if nothing has changed.</p>
<h3>Use fdisk to delete partition</h3>
<p>Before we can create the ZFS pool we need to delete all partitions from the second SSD, which is <code>/dev/sda</code>. For this we can use <code>fdisk</code>.</p>
<div class="highlight"><pre><span></span><code>$ sudo fdisk /dev/sda

Welcome to fdisk (util-linux 2.36).
Changes will remain in memory only, until you decide to write them.
Be careful before using the write command.


Command (m for help): d
Selected partition 1
Partition 1 has been deleted.

Command (m for help): w

The partition table has been altered.
Calling ioctl() to re-read partition table.
Synching disks.
</code></pre></div>

<p>Using <code>d</code> to delete the partition as there was only one and then <code>w</code> to write the changes to the partition table.</p>
<h3>Create a ZFS pool</h3>
<p>The preparation is done so now we can finally create the ZFS pool. I'm going with <code>mypool</code> for lack of a better name but feel free to choose whatever you like. I also only have the one drive so don't need to worry about any sort of RAIDZ or mirroring. If you have multiple drives you'd like in your pool you'll want to check out the manpages for <code>zpool create</code>.</p>
<div class="highlight"><pre><span></span><code>sudo zpool create mypool /dev/sda
</code></pre></div>

<p>Then just a quick <code>zpool status</code> to check it was created.</p>
<div class="highlight"><pre><span></span><code>$ sudo zpool status
pool: mypool
state: ONLINE
scan: none requested
config:

    NAME        STATE     READ WRITE CKSUM
    mypool      ONLINE       0     0     0
    sda         ONLINE       0     0     0

errors: No known data errors
</code></pre></div>

<h3>Create the ZFS filesystem</h3>
<p>Next create the <code>home</code> filesystem in the pool.</p>
<div class="highlight"><pre><span></span><code>sudo zfs create mypool/home
</code></pre></div>

<p>And check it was created.</p>
<div class="highlight"><pre><span></span><code>sudo zfs list
NAME          USED  AVAIL     REFER  MOUNTPOINT
mypool        984K   225G      192K  /mypool
mypool/home   192K   225G      192K  /mypool/home
</code></pre></div>

<h3>Enable Compression</h3>
<p>Another benefit of ZFS is being able to use compression, there is a slight performance hit for doing this but since it's just my home directory I don't see this causing me any issues. So let's enable that now.</p>
<div class="highlight"><pre><span></span><code>sudo zfs set compression=lz4 mypool
</code></pre></div>

<p>I'm going to go with lz4 since this gives a great compression ratio for minimal performance impact. ServeTheHome have a great <a href="https://www.servethehome.com/the-case-for-using-zfs-compression/">article</a> about it. </p>
<h3>Copy /temp-home to it's new home</h3>
<p>Great! Now that we have the filesystem and it is mounted at <code>/mypool/home</code> we can copy all the contents of the <code>/temp-home/</code> directory to it once again using the <code>cp -a</code> command.</p>
<div class="highlight"><pre><span></span><code>sudo cp -av /temp-home/* /mypool/home
</code></pre></div>

<p>Then check the pool usage and compression ratio.</p>
<div class="highlight"><pre><span></span><code>$ sudo zfs list -o name,used,avail,refer,mountpoint,compressratio
NAME          USED  AVAIL     REFER  MOUNTPOINT     RATIO
mypool       54.9G   170G      192K  /mypool        1.22x
mypool/home  54.9G   170G     54.9G  /mypool/home   1.22x
</code></pre></div>

<p>And yep, we can now see that 54.9G is used up and the compression ratio is 1.22x. Compression has definitely paid off!</p>
<h3>Delete everything in /home and mount the ZFS filesystem</h3>
<p>Now to clean up and get the ZFS filesystem mounted at <code>/home</code>.</p>
<p>Delete the <code>/home</code> directory.</p>
<div class="highlight"><pre><span></span><code>sudo rm -rf /home
</code></pre></div>

<p>Then change the mountpoint of <code>mypool/home</code> to <code>/home</code>. And while we are it we can stop <code>mypool</code> from mounting by setting it's mountpoint to <code>none</code></p>
<div class="highlight"><pre><span></span><code>sudo zfs set mountpoint=/home mypool/home
sudo zfs set mountpoint=none mypool
</code></pre></div>

<p>Check that the files are there in <code>/home</code>.</p>
<div class="highlight"><pre><span></span><code>$ ll /home
total 22
drwxr-xr-x  4 root root    4 Apr  6 12:40 ./
drwxr-xr-x 24 root root 4096 Apr  6 12:46 ../
drwx------  2 root root    2 Mar  4 17:42 lost+found/
drwxr-xr-x 46 ross ross   72 Apr  6 13:57 ross/
</code></pre></div>

<p>Awesome! Everything is there and now on a ZFS filesystem.</p>
<h3>Reboot</h3>
<p>Finally a quick reboot to make sure it mounts correctly on boot, there's no reason it shouldn't but better to be safe than sorry.</p>
<div class="highlight"><pre><span></span><code>sudo reboot
</code></pre></div>

<p>And everything is there as expected. Success!</p>
<div class="highlight"><pre><span></span><code>$ ll /home
total 22
drwxr-xr-x  4 root root    4 Apr  6 12:40 ./
drwxr-xr-x 24 root root 4096 Apr  6 12:46 ../
drwx------  2 root root    2 Mar  4 17:42 lost+found/
drwxr-xr-x 46 ross ross   72 Apr  6 13:57 ross/
</code></pre></div>

<h3>Summary</h3>
<p>This process would have been a bit less painful if I'd use a LiveCD environment as I wouldn't have to have copies of copies of my home directory but overall it seems to have gone well.</p>
<p>I'm going to keep <code>/temp-home</code> around for a week or so just incase something goes wrong but once I'm happy everything is okay that will be deleted.</p>
<p>The next steps are to learn more about ZFS snapshots and replication so that I can start using these for my backups. I'm pretty new to ZFS and this is the first time I've created pools and file systems in this manor, my only previous experience was in TrueNAS which gives a nice web UI interface for performing all these tasks.</p>
<p>I've heard great things about <a href="https://github.com/jimsalterjrs/sanoid">sanoid</a> so I'm probably going to go with that for my snapshot and backup solution. I'll of course write a blog post about it but for now I'm just going to keep my <code>rsync</code> cronjob around for backups.</p>
<p>If you have any questions or suggestions for using ZFS please get in touch. Contact details be found <a href="https://rossw.co.uk/pages/about.html">here</a>.</p>
                <section>
                <p id="post-share-links">
                    Share on:
                    <a href="https://twitter.com/intent/tweet?text=Giving%20/home%20a%20new%20home%20on%20ZFS&url=https%3A//rossw.co.uk/home-to-zfs.html&hashtags=zfs,linux,ubuntu,sysadmin" title="Share on Twitter">Twitter</a>
                    ·
                    <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A//rossw.co.uk/home-to-zfs.html" title="Share on Facebook">Facebook</a>
                    ·
                    <a href="https://www.reddit.com/submit?url=https%3A//rossw.co.uk/home-to-zfs.html&title=Giving%20/home%20a%20new%20home%20on%20ZFS" title="Share via Reddit">Reddit</a>
                    ·
                    <a href="mailto:?subject=Giving%20/home%20a%20new%20home%20on%20ZFS&amp;body=https%3A//rossw.co.uk/home-to-zfs.html" title="Share via Email">Email</a>
                </p>
                </section>
                <div class="clear"></div>

                <div class="info">
                    <a href="https://rossw.co.uk/home-to-zfs.html">posted at 10:00</a>
                    &nbsp;&middot;&nbsp;<a href="https://rossw.co.uk/category/linux.html" rel="tag">Linux</a>
                    &nbsp;&middot;
                    &nbsp;<a href="https://rossw.co.uk/tag/zfs.html" class="tags">zfs</a>
                    &nbsp;<a href="https://rossw.co.uk/tag/linux.html" class="tags">linux</a>
                    &nbsp;<a href="https://rossw.co.uk/tag/ubuntu.html" class="tags selected">ubuntu</a>
                    &nbsp;<a href="https://rossw.co.uk/tag/sysadmin.html" class="tags">sysadmin</a>
                </div>
            </article>

            <div class="clear"></div>
            <footer>
                <p>
                <a href="https://github.com/rosswf"><img src="https://rossw.co.uk/theme/images/GitHub-Mark-32px.webp" alt="My Github" width="32" height="32"></a>
                <a href="https://twitter.com/rossw_"><img src="https://rossw.co.uk/theme/images/2021-Twitter-logo-black.webp" alt="My Twitter" width="32" height="26"></a>
                </p>
                <p>
                Modified <a href="https://github.com/jody-frankowski/blue-penguin">Blue Penguin</a> Theme
                &middot;
                Powered by <a href="http://getpelican.com">Pelican</a>
                &middot;
                <a href="https://rossw.co.uk/feeds/all.rss.xml" rel="alternate">Rss Feed</a>
            </footer>
        </div>
        <div class="clear"></div>
    </div>
    <a href="https://github.com/rosswf" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#15A9DB; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>
</body>
</html>
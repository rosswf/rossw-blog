<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>
RossW.co.uk | Page 2    </title>
    <link rel="shortcut icon" type="image/png" href="https://rossw.co.uk/favicon.png">
    <link rel="shortcut icon" type="image/x-icon" href="https://rossw.co.uk/favicon.ico">
    <link href="https://rossw.co.uk/feeds/all.rss.xml" type="application/rss+xml" rel="alternate" title="RossW.co.uk Full RSS Feed" />
    <link rel="stylesheet" href="https://rossw.co.uk/theme/css/main.css" type="text/css" />
    <link rel="stylesheet" href="https://rossw.co.uk/theme/css/pygments.css" type="text/css" />
    <meta name="generator" content="Pelican" />
    <meta name="author" content="Ross" />

<meta name="description" content="Learn with me. Programming, DevOps, Homelabs & more" />
</head>
<body>
    <header>
        <nav>
            <ul>
                <li><a href="https://rossw.co.uk/">Home</a></li>
                <li><a href="https://rossw.co.uk/pages/about.html">About</a></li>
                <li><a href="https://rossw.co.uk/archive">Archives</a></li>
            </ul>
        </nav>
        <div class="header_box">
            <h1><a href="https://rossw.co.uk/">RossW.co.uk</a></h1>
            <h2>Programming, DevOps, Homelabs & more</h2>
        </div>
    </header>
    <div id="wrapper">
        <div id="content">            <h4 class="date">Apr 24, 2021</h4>

            <article class="post">
                <h2 class="title">
                    <a href="https://rossw.co.uk/pxeboot-ubuntu-pfsense.html" rel="bookmark" title="Permanent Link to &quot;Netbooting the Ubuntu 21.04 Installer&quot;">Netbooting the Ubuntu 21.04 Installer</a>
                </h2>

                
                

                <p>Ubuntu 21.04 Hirsute Hippo is here! Today I'm going to look at how to use pfSense to boot into the installer over the network. I am going to be installing the Desktop version but the same would apply to the Server version as well.</p>
<p>There are a couple of reasons that I can think of that you might want to do this.</p>
<ol>
<li>If you have a lot of computers you'd like to install on at once, you don't have to have multiple usb drives or CDs.</li>
<li>You misplaced your usb drive that was large enough to fit in the installer on it.</li>
</ol>
<p>I would be doing this because of the second reason... and because it's a fun learning experience.</p>
<p>I have loosely followed the instructions from this <a href="https://discourse.ubuntu.com/t/netbooting-the-live-server-installer/14510">guide</a>.</p>
<h3>Gathering all the files</h3>
<p>There are a few files that we need to get this to work. Two from syslinux and two from the ubuntu ISO itself. We also need to write a short configuration file.</p>
<p>Let's start with syslinux. We need <code>pxelinux.0</code> and <code>ldlinux.c32</code>. The easiest way I find to get these is to download syslinux from <a href="https://mirrors.edge.kernel.org/pub/linux/utils/boot/syslinux/">kernel.org</a> and just extract them.</p>
<div class="highlight"><pre><span></span><code>$ cp bios/core/pxelinux.0 ~/netboot-files/
$ cp bios/com32/elflink/ldlinux/ldlinux.c32 ~/netboot-files/
</code></pre></div>

<p>Now we have those we need <code>initrd</code> and <code>vmlinuz</code> from the Ubuntu 21.04 installer. So let's <a href="https://ubuntu.com/">download</a> it, mount it and grab those files.</p>
<div class="highlight"><pre><span></span><code>$ sudo mkdir /media/iso
$ sudo mount ubuntu-21.04-desktop-amd64.iso /media/iso
$ cp /media/iso/casper/{initrd,vmlinuz} ~/netboot-files/
$ sudo umount /media/iso
</code></pre></div>

<p>Finally we need to create a configuration file for pxelinux.</p>
<div class="highlight"><pre><span></span><code>$ mkdir ~/netboot-files/pxelinux.cfg/
$ touch ~/netboot-files/pxelinux.cfg/default
</code></pre></div>

<p>Then using your favourite text editor put the following into the <code>default</code> file.</p>
<div class="highlight"><pre><span></span><code>DEFAULT install
LABEL install
    KERNEL vmlinuz
    INITRD initrd
    APPEND root=/dev/ram0 ramdisk_size=4000000 ip=dhcp url=https://releases.ubuntu.com/21.04/ubuntu-21.04-desktop-amd64.iso
</code></pre></div>

<p>Here I've set the size of the ramdisk to ~4GB, the thought behind this was that the iso is 2.8GB and we need some room for the actual installation. This might be way too much, I haven't really experimented with it but it works.</p>
<p>This is an extremely basic configuration, you can go quite in depth with pxelinux. There are modules for doing all sorts of things such as creating menus. I'd recommend reading the <a href="https://wiki.syslinux.org/wiki/index.php?title=PXELINUX">wiki</a> for more information.</p>
<p>If you've followed all the steps above you should have:</p>
<div class="highlight"><pre><span></span><code>$ ls -AlR ~/netboot-files
/home/ross/netboot-files:
total 126115
-r--r--r-- 1 ross ross 115774131 Apr 24 14:59 initrd
-rwxrwxr-x 1 ross ross    122308 Apr 24 14:49 ldlinux.c32
-rw-rw-r-- 1 ross ross     46909 Apr 24 14:49 pxelinux.0
drwxrwxr-x 2 ross ross         3 Apr 24 15:02 pxelinux.cfg
-r--r--r-- 1 ross ross  14732384 Apr 24 14:59 vmlinuz

/home/ross/netboot-files/pxelinux.cfg:
total 1
-rw-rw-r-- 1 ross ross 0 Apr 24 15:02 default
</code></pre></div>

<h3>Setting up TFTP in pfSense</h3>
<p>Since pfSense is already acting as the dhcp server it makes it really simple to get everything up and running. The only thing we need is a TFTP server which pfSense has a package for.</p>
<p>This can be done by navigating to System -&gt; Package Manager then going to Available Packages and installing the one called tftpd.</p>
<p>Once this is installed you can navigate to Services-&gt;TFTP Server and check "Enable TFTP service" if it isn't already enabled.</p>
<p><img alt="pfSense tftp settings" src="https://rossw.co.uk/images/pxeboot-ubuntu-pfsense/tftp-settings.webp"></p>
<p>Now we need to get our files from <code>~/netboot-files</code> onto pfSense in the correct location. You can use the webUI to do this by going to the Files section but you can only do one file at time as far as I can tell and it won't handle the folder containing the configuration.</p>
<p>The easiest way is just to use scp.</p>
<div class="highlight"><pre><span></span><code>$ scp -r ~/netboot-files/* admin@192.168.0.1:/tftpboot/
initrd         100%  110MB  93.3MB/s   00:01    
ldlinux.c32    100%  119KB  60.2MB/s   00:00    
pxelinux.0     100%   46KB  46.2MB/s   00:00    
default        100%  185   621.3KB/s   00:00    
vmlinuz        100%   14MB  92.9MB/s   00:00
</code></pre></div>

<h3>pfSense DHCP Configuration</h3>
<p>Now that TFTP is up and running there's some configuration we need to do for the dhcp server to tell enable network booting and point it at our TFTP server.</p>
<p>Navigate to Services-&gt;DHCP Server and scroll all the way down to near the bottom where you should see TFTP and Network Booting options. Click Display Advanced to see all the options.
Check the enable box and then there are just a few fields we need to fill in. 
The IP address for my pfSense is 192.168.0.1 but change your to suit.</p>
<p><img alt="pfSense dhcp settings" src="https://rossw.co.uk/images/pxeboot-ubuntu-pfsense/dhcp-settings.webp"></p>
<h3>Installing Ubuntu!</h3>
<p>That's everything we need to do in pfSense. We should now to be able to boot over the network so let's give it a go.</p>
<p>I'm going to use a virtual box VM for this so I can easily capture the process but it absolutely works on physical hardware but you may have to tweak some BIOS settings since this particular setup is not using UEFI.</p>
<p><img alt="Booting - Part 1" src="https://rossw.co.uk/images/pxeboot-ubuntu-pfsense/booting-1.webp"></p>
<p>It's found our TFP server and is loading the ramdisk.</p>
<p><img alt="Booting - Part 2" src="https://rossw.co.uk/images/pxeboot-ubuntu-pfsense/booting-2.webp"></p>
<p>Downloading of the ISO has started.</p>
<p><img alt="Booting - Part 3" src="https://rossw.co.uk/images/pxeboot-ubuntu-pfsense/booting-3.webp"></p>
<p>And a few minutes later we are in! We can now install Ubuntu 21.04.</p>
<h3>Summary</h3>
<p>pfSense makes this whole process fairly painless with very minimal configuration required thanks to it's plugins. If you are not using pfSense I recommend following the <a href="https://discourse.ubuntu.com/t/netbooting-the-live-server-installer/14510">guide</a> I linked for setting up dhcp and TFTP manually.</p>
<p>These steps are a very minimal configuration and what if we wanted to be able to serve two different distros installers over the network, say we had an LTS for servers and the latest version for any desktops? Well, this should be possible with syslinux/pxelinux and I definitely intend to dive deeper into it in future and explore it's modules. </p>
<p>If any of you have any cool setups for this then get in touch and let me know. Contact details be found <a href="https://rossw.co.uk/pages/about.html">here</a>.</p>
                <section>
                <p id="post-share-links">
                    Share on:
                    <a href="https://twitter.com/intent/tweet?text=Netbooting%20the%20Ubuntu%2021.04%20Installer&url=https%3A//rossw.co.uk/pxeboot-ubuntu-pfsense.html&hashtags=pfsense,tftp,pxe,netboot,ubuntu,hirsute-hippo" title="Share on Twitter">Twitter</a>
                    ·
                    <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A//rossw.co.uk/pxeboot-ubuntu-pfsense.html" title="Share on Facebook">Facebook</a>
                    ·
                    <a href="https://www.reddit.com/submit?url=https%3A//rossw.co.uk/pxeboot-ubuntu-pfsense.html&title=Netbooting%20the%20Ubuntu%2021.04%20Installer" title="Share via Reddit">Reddit</a>
                    ·
                    <a href="mailto:?subject=Netbooting%20the%20Ubuntu%2021.04%20Installer&amp;body=https%3A//rossw.co.uk/pxeboot-ubuntu-pfsense.html" title="Share via Email">Email</a>
                </p>
                </section>
                <div class="clear"></div>

                <div class="info">
                    <a href="https://rossw.co.uk/pxeboot-ubuntu-pfsense.html">posted at 16:30</a>
                    &nbsp;&middot;&nbsp;<a href="https://rossw.co.uk/category/pfsense.html" rel="tag">pfSense</a>
                    &nbsp;&middot;
                    &nbsp;<a href="https://rossw.co.uk/tag/pfsense.html" class="tags">pfsense</a>
                    &nbsp;<a href="https://rossw.co.uk/tag/tftp.html" class="tags">tftp</a>
                    &nbsp;<a href="https://rossw.co.uk/tag/pxe.html" class="tags">pxe</a>
                    &nbsp;<a href="https://rossw.co.uk/tag/netboot.html" class="tags">netboot</a>
                    &nbsp;<a href="https://rossw.co.uk/tag/ubuntu.html" class="tags">ubuntu</a>
                    &nbsp;<a href="https://rossw.co.uk/tag/hirsute-hippo.html" class="tags">hirsute hippo</a>
                </div>
            </article>            <h4 class="date">Apr 17, 2021</h4>

            <article class="post">
                <h2 class="title">
                    <a href="https://rossw.co.uk/openvpn-pfsense.html" rel="bookmark" title="Permanent Link to &quot;Setting up OpenVPN on pfSense&quot;">Setting up OpenVPN on pfSense</a>
                </h2>

                
                

                <p>I would like to have the ability to connect to my home network wherever I am in the world so I have decided to setup a VPN. 
I'm running pfSense as my router/firewall solution which makes this really easy!</p>
<p>There are a few reasons I'd like to do this:</p>
<ul>
<li>Ensuring that my traffic is encrypted when connected to a public network.</li>
<li>Using my own Pi-hole DNS wherever I am in the world.</li>
<li>Securely self hosting various services that I can access from anywhere. Using bitwarden in this way is something I'd like to explore in the near future.</li>
<li>Ability to remotely manage my home infrastructure from anywhere.</li>
</ul>
<p>I had originally planned to use Wireguard for my VPN solution as it was added to pfSense in version 2.5.0, however it has now been removed in version 2.5.1. You can read more in this <a href="https://www.netgate.com/blog/wireguard-removed-from-pfsense-ce-and-pfsense-plus-software.html">blog</a> post. This is extremely unfortunate but I'm sure it was done for the right reasons. I'll be keeping an eye on the progress of wireguard within FreeBSD &amp; pfSense, hopefully any issues can be quickly resolved.</p>
<h3>Getting Started</h3>
<p>The pfSense documentation has a great guide on how to do this in it's recipe section so instead of going over each step in minute detail here is the relevant <a href="https://docs.netgate.com/pfsense/en/latest/recipes/openvpn-ra.html">recipe</a>. 
I'm just going to quickly run through it at a high level and provide information on various settings I changed. Also I'm not sure when the documentation is written but it differed slightly to what is the latest version as I'm writing this post, pfSense 2.5.1.</p>
<p><strong><em>If you haven't checked out the recipe section of pfSense's documentation before I highly recommend you do so, it has a ton of information on how to perform various different tasks and setup all sorts of functionality.</em></strong></p>
<p>The first thing we need to do is to go to VPN -&gt; OpenVPN in the navbar at the top then click the link for the wizard which walks you through the process of getting everything setup.</p>
<p>I'm going to number the steps based on the order in which we go through them, you'll notice that the wizard within pfSense may jump a few steps at a time, this is due to the options we are choosing. We do not have to complete all 11 steps.</p>
<h3>Step 1 - Authentication Backend</h3>
<p>The first screen asks what authentication backend is to be used. We are just going to leave this on Local User Access and click next. In a later step we will create the user within pfSense itself.</p>
<p><img alt="pfSense OpenVPN Wizard Step 1" src="https://rossw.co.uk/images/openvpn-pfsense/part1.webp"></p>
<h3>Step 2 - Creating a Certificate Authority</h3>
<p>A certificate authority is required to generate &amp; sign certificates used by clients to authenticate with the server. It can also revoke certificates.</p>
<p>For the purposes of this I'm just going to use rossw as my organisation but you should use whatever you feel would be the best bit and ensure that all the fields are filled in.</p>
<p>Once done we simply click Add new CA. </p>
<p>We only need to do this step once since you can continue to use this same Certificate Authority in future.</p>
<p><img alt="pfSense OpenVPN Wizard Step 2" src="https://rossw.co.uk/images/openvpn-pfsense/part2.webp"></p>
<h3>Step 3 - Create a Server Certificate</h3>
<p>Now that we have a CA we need to generate a certificate that the server will use to identify itself to any clients that are trying to connect. </p>
<p>The pfSense documentation recommends using the hostname for the Descriptive name so I'll use pfsense.rossw.co.uk as an example here and once again the organisation will be rossw. You should once again use whatever makes the most sense for your use case.</p>
<p>This is very similar to the previous step and there is quite a bit of duplication from the so once it's complete click create new certificate and we will move on.</p>
<p><img alt="pfSense OpenVPN Wizard Step 3" src="https://rossw.co.uk/images/openvpn-pfsense/part3.webp"></p>
<h3>Step 4 - Server Setup</h3>
<p>This next page can seem quite overwhelming at first since there are a lot of different options. However the <a href="https://docs.netgate.com/pfsense/en/latest/recipes/openvpn-ra.html">recipe</a> explains each of the options in plenty of detail, and in most cases the default is fine.</p>
<p><img alt="pfSense OpenVPN Wizard Step 4 - General" src="https://rossw.co.uk/images/openvpn-pfsense/part4-1.webp"></p>
<p>The general server settings are quite straight forward. I went with the defaults here.</p>
<p><img alt="pfSense OpenVPN Wizard Step 4 - Cryptographic" src="https://rossw.co.uk/images/openvpn-pfsense/part4-2.webp"></p>
<p>Again we can mostly go with the default here. Just make sure TLS Authentication and Generate TLS Key are selected as explained in the <a href="https://docs.netgate.com/pfsense/en/latest/recipes/openvpn-ra.html">recipe</a>.</p>
<p><img alt="pfSense OpenVPN Wizard Step 4 - Tunnel" src="https://rossw.co.uk/images/openvpn-pfsense/part4-3.webp"></p>
<p>Next is the tunnel settings, this is where you will want to change a few values.</p>
<ul>
<li>
<p>Tunnel network. I Chose 192.168.10.0/24 here because my home network is on 192.168.0.0/24. The 10 was just an arbitrary number. You can choose whatever you'd like really.</p>
</li>
<li>
<p>Redirect Gateway. I've enabled this as one of the main reasons for wanting to setup a vpn is for security when on public networks so I want all my traffic to be forced through the VPN.</p>
</li>
<li>
<p>Local Network. As mentioned earlier my local network is 192.168.0.0/24 but you should enter yours here. So if it was 192.168.1.0/24 you'd enter that here for example.</p>
</li>
</ul>
<p>The rest I have left as the default but feel free to explore compression and what that means for security if bandwidth is a concern to you.</p>
<p><img alt="pfSense OpenVPN Wizard Step 4 - Client" src="https://rossw.co.uk/images/openvpn-pfsense/part4-4.webp"></p>
<p>Finally we have client settings. Here I just provide the ip address of my pi-hole for the DNS as I want all my DNS to go through that.</p>
<h3>Step 5 - Firewall Configuration</h3>
<p>On this final screen we tell pfSense to create the relevant firewall rules for allowing VPN connections and traffic through the tunnel.</p>
<p>This will allow connections from anywhere to attempt to connect to the VPN, if you'd like to lock this down then make sure you edit the firewall rules accordingly.</p>
<p><img alt="pfSense OpenVPN Wizard Step 5 - Firewall" src="https://rossw.co.uk/images/openvpn-pfsense/part5.webp"></p>
<h3>Finished! - but not quite...</h3>
<p>The final screen lets you know that the server configuration is complete. But we aren't quite finished yet. </p>
<p><img alt="pfSense OpenVPN Wizard - Finished!" src="https://rossw.co.uk/images/openvpn-pfsense/finished.webp"></p>
<p>Remember how in the first step I mentioned we need to create a user? Let's do that now.</p>
<h3>Step 6 - Adding a User</h3>
<p>Navigate to System -&gt; User Manager then click the Add button.</p>
<p>Fill in your desired Username, Password and Full name. I already have a user for this so I've just filled in some example information.</p>
<p>It is also important to click the "Click to create a user certificate" check box so that a certificate that the user will need to authenticate with OpenVPN is generated.</p>
<p>Give this a Descriptive name and select the certificate authority we created when setting up OpenVPN. The defaults are fine for the rest of it. Then simply scroll down a click Save.</p>
<p><img alt="pfSense OpenVPN Wizard - Step 6" src="https://rossw.co.uk/images/openvpn-pfsense/part6.webp"></p>
<h3>Step 7 - Client Export</h3>
<p>As explained in the <a href="https://docs.netgate.com/pfsense/en/latest/recipes/openvpn-ra.html">recipe</a> the easiest way to export configuration for different VPN clients is to use the OpenVPN Client Export Package. </p>
<p>This can be done by navigating to System -&gt; Package Manager then going to Available Packages and installing the one called openvpn-client-export.</p>
<p>This will give us a new option under VPN -&gt; OpenVPN called Client Export. Simply navigate here and then choose the Remote Access Server, in this case we only have a single OpenVPN server so it will already be selected for us. The rest of the settings can be left at default.</p>
<p>Scroll down to the bottom and there will be a list of OpenVPN clients, click the one that is relevant to yourself and it should begin the download. You can find more information in the <a href="https://docs.netgate.com/pfsense/en/latest/packages/openvpn-client-export.html">documentation</a>.</p>
<p>Initially I am just going to set this up on my Android phone so I'll choose Android under Inline Configurations.</p>
<p><img alt="pfSense OpenVPN Wizard - Step 7 - 1" src="https://rossw.co.uk/images/openvpn-pfsense/part7-1.webp">
<img alt="pfSense OpenVPN Wizard - Step 7 - 2" src="https://rossw.co.uk/images/openvpn-pfsense/part7-2.webp"></p>
<p>It is vitally important that you keep this configuration safe and secure. If anybody gets access to it they will be able to connect to your VPN.</p>
<p>Once you have the configuration downloaded simply import it into your VPN client of choice and you should be able to connect!</p>
<h3>Finally Finished!</h3>
<p>So let's give it a whirl. I'll open up the OpenVPN client on my phone, import the configuration, try to connect and enter my password when prompted. </p>
<p>To make sure it's working I'll try to browse to my TrueNAS web UI and see if it loads.</p>
<p><img alt="pfSense OpenVPN Wizard - Finally" src="https://rossw.co.uk/images/openvpn-pfsense/finally.webp"></p>
<p><strong>Success!</strong> </p>
<p>I can now securely access my home network from anywhere in the world and all my DNS requests are going through my Pi-hole for ad blocking on the move.</p>
                <section>
                <p id="post-share-links">
                    Share on:
                    <a href="https://twitter.com/intent/tweet?text=Setting%20up%20OpenVPN%20on%20pfSense&url=https%3A//rossw.co.uk/openvpn-pfsense.html&hashtags=pfsense,openvpn,firewall,remote-access" title="Share on Twitter">Twitter</a>
                    ·
                    <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A//rossw.co.uk/openvpn-pfsense.html" title="Share on Facebook">Facebook</a>
                    ·
                    <a href="https://www.reddit.com/submit?url=https%3A//rossw.co.uk/openvpn-pfsense.html&title=Setting%20up%20OpenVPN%20on%20pfSense" title="Share via Reddit">Reddit</a>
                    ·
                    <a href="mailto:?subject=Setting%20up%20OpenVPN%20on%20pfSense&amp;body=https%3A//rossw.co.uk/openvpn-pfsense.html" title="Share via Email">Email</a>
                </p>
                </section>
                <div class="clear"></div>

                <div class="info">
                    <a href="https://rossw.co.uk/openvpn-pfsense.html">posted at 08:10</a>
                    &nbsp;&middot;&nbsp;<a href="https://rossw.co.uk/category/pfsense.html" rel="tag">pfSense</a>
                    &nbsp;&middot;
                    &nbsp;<a href="https://rossw.co.uk/tag/pfsense.html" class="tags">pfsense</a>
                    &nbsp;<a href="https://rossw.co.uk/tag/openvpn.html" class="tags">openvpn</a>
                    &nbsp;<a href="https://rossw.co.uk/tag/firewall.html" class="tags">firewall</a>
                    &nbsp;<a href="https://rossw.co.uk/tag/remote-access.html" class="tags">remote access</a>
                </div>
            </article>            <h4 class="date">Apr 10, 2021</h4>

            <article class="post">
                <h2 class="title">
                    <a href="https://rossw.co.uk/home-to-zfs.html" rel="bookmark" title="Permanent Link to &quot;Giving /home a new home on ZFS&quot;">Giving /home a new home on ZFS</a>
                </h2>

                
                

                <p>Currently on my main desktop machine my <code>/home</code> directory resides on it's own 256gb SSD with an ext4 filesystem. I want to move this to a ZFS file system to take advantage of snapshots and compression.</p>
<p>I have a TrueNAS VM running in proxmox (more on this in future posts) that <code>/home</code> then gets backed up to using an <code>rsync</code> cronjob. However as I mentioned previously I would like to be able to take advantage of ZFS snapshots when doing backups so I have decided to move <code>/home</code> to ZFS. 
I run ubuntu 20.10 on my desktop PC so this is fairly straight forward. ZFS is supported out of the box in the kernel on ubuntu. </p>
<p>The only aspect that makes this a little bit messy is that I want to use ZFS on the existing SSD that currently has <code>/home</code> on it. I'll need to do quite a bit of juggling files!</p>
<p>I am going to performing these steps on the live filesystem. I would recommend using a LiveCD for performing these tasks where possible, it'll make it a bit easier.</p>
<h3>Install ZFS tools</h3>
<p>First of all, let's install the tools required for managing zfs using apt.</p>
<div class="highlight"><pre><span></span><code>sudo apt install zfsutils-linux
</code></pre></div>

<h3>Copy /home to a temporary location</h3>
<p>The next thing to do is copy the entire contents of the <code>/home</code> directory that currently resides on the SSD to a temporary location. I have plenty of space on my main drive so I'm just going to create a folder there and copy everything to it but if you don't then feel free to use an external drive.</p>
<div class="highlight"><pre><span></span><code>sudo mkdir /temp-hone
sudo cp -av /home/* /temp-home/
</code></pre></div>

<p>Using the <code>-a</code> flag with <code>cp</code> preserves all file attributes and copies recursively so there shouldn't be any strange file permission issues.</p>
<h3>Edit fstab and un-mount the drive</h3>
<p>Now that the <code>/home</code> directory has been safely copied to another location <code>fstab</code> can be edited to stop the partition being mounted at boot. For now we can simply comment out the relevant line incase something goes wrong and we need to revert this step.</p>
<div class="highlight"><pre><span></span><code>sudo vim /etc/fstab

# /home was on /dev/sda1 during installation
# UUID=myuuid /home           ext4    defaults
</code></pre></div>

<p>Next we can un-mount the drive. We use the <code>-lf</code> flags for force and lazy un-mounting. Without this it won't work as there are programs running that are actively trying to access this file system. As I mentioned in the introduction, doing this in a live filesystem is less than ideal, which is why we had to take this step.</p>
<div class="highlight"><pre><span></span><code>sudo umount -lf /dev/sda1
</code></pre></div>

<h3>Copy /temp-home back to /home</h3>
<p>Due to doing this live and having plenty of drive space we are going to copy the <code>/temp-home/</code> to <code>/home</code> so that when we reboot everything is where ubuntu suspects it to be, this now resides on the main OS drive.
A reboot is required because the <code>home</code> drive was unmounted lazily and we need to be able to delete the partition(s) so that ZFS can do it's thing! </p>
<div class="highlight"><pre><span></span><code>sudo cp -a /temp-home/* /home/
reboot
</code></pre></div>

<p>The system should come back up as if nothing has changed.</p>
<h3>Use fdisk to delete partition</h3>
<p>Before we can create the ZFS pool we need to delete all partitions from the second SSD, which is <code>/dev/sda</code>. For this we can use <code>fdisk</code>.</p>
<div class="highlight"><pre><span></span><code>$ sudo fdisk /dev/sda

Welcome to fdisk (util-linux 2.36).
Changes will remain in memory only, until you decide to write them.
Be careful before using the write command.


Command (m for help): d
Selected partition 1
Partition 1 has been deleted.

Command (m for help): w

The partition table has been altered.
Calling ioctl() to re-read partition table.
Synching disks.
</code></pre></div>

<p>Using <code>d</code> to delete the partition as there was only one and then <code>w</code> to write the changes to the partition table.</p>
<h3>Create a ZFS pool</h3>
<p>The preparation is done so now we can finally create the ZFS pool. I'm going with <code>mypool</code> for lack of a better name but feel free to choose whatever you like. I also only have the one drive so don't need to worry about any sort of RAIDZ or mirroring. If you have multiple drives you'd like in your pool you'll want to check out the manpages for <code>zpool create</code>.</p>
<div class="highlight"><pre><span></span><code>sudo zpool create mypool /dev/sda
</code></pre></div>

<p>Then just a quick <code>zpool status</code> to check it was created.</p>
<div class="highlight"><pre><span></span><code>$ sudo zpool status
pool: mypool
state: ONLINE
scan: none requested
config:

    NAME        STATE     READ WRITE CKSUM
    mypool      ONLINE       0     0     0
    sda         ONLINE       0     0     0

errors: No known data errors
</code></pre></div>

<h3>Create the ZFS filesystem</h3>
<p>Next create the <code>home</code> filesystem in the pool.</p>
<div class="highlight"><pre><span></span><code>sudo zfs create mypool/home
</code></pre></div>

<p>And check it was created.</p>
<div class="highlight"><pre><span></span><code>sudo zfs list
NAME          USED  AVAIL     REFER  MOUNTPOINT
mypool        984K   225G      192K  /mypool
mypool/home   192K   225G      192K  /mypool/home
</code></pre></div>

<h3>Enable Compression</h3>
<p>Another benefit of ZFS is being able to use compression, there is a slight performance hit for doing this but since it's just my home directory I don't see this causing me any issues. So let's enable that now.</p>
<div class="highlight"><pre><span></span><code>sudo zfs set compression=lz4 mypool
</code></pre></div>

<p>I'm going to go with lz4 since this gives a great compression ratio for minimal performance impact. ServeTheHome have a great <a href="https://www.servethehome.com/the-case-for-using-zfs-compression/">article</a> about it. </p>
<h3>Copy /temp-home to it's new home</h3>
<p>Great! Now that we have the filesystem and it is mounted at <code>/mypool/home</code> we can copy all the contents of the <code>/temp-home/</code> directory to it once again using the <code>cp -a</code> command.</p>
<div class="highlight"><pre><span></span><code>sudo cp -av /temp-home/* /mypool/home
</code></pre></div>

<p>Then check the pool usage and compression ratio.</p>
<div class="highlight"><pre><span></span><code>$ sudo zfs list -o name,used,avail,refer,mountpoint,compressratio
NAME          USED  AVAIL     REFER  MOUNTPOINT     RATIO
mypool       54.9G   170G      192K  /mypool        1.22x
mypool/home  54.9G   170G     54.9G  /mypool/home   1.22x
</code></pre></div>

<p>And yep, we can now see that 54.9G is used up and the compression ratio is 1.22x. Compression has definitely paid off!</p>
<h3>Delete everything in /home and mount the ZFS filesystem</h3>
<p>Now to clean up and get the ZFS filesystem mounted at <code>/home</code>.</p>
<p>Delete the <code>/home</code> directory.</p>
<div class="highlight"><pre><span></span><code>sudo rm -rf /home
</code></pre></div>

<p>Then change the mountpoint of <code>mypool/home</code> to <code>/home</code>. And while we are it we can stop <code>mypool</code> from mounting by setting it's mountpoint to <code>none</code></p>
<div class="highlight"><pre><span></span><code>sudo zfs set mountpoint=/home mypool/home
sudo zfs set mountpoint=none mypool
</code></pre></div>

<p>Check that the files are there in <code>/home</code>.</p>
<div class="highlight"><pre><span></span><code>$ ll /home
total 22
drwxr-xr-x  4 root root    4 Apr  6 12:40 ./
drwxr-xr-x 24 root root 4096 Apr  6 12:46 ../
drwx------  2 root root    2 Mar  4 17:42 lost+found/
drwxr-xr-x 46 ross ross   72 Apr  6 13:57 ross/
</code></pre></div>

<p>Awesome! Everything is there and now on a ZFS filesystem.</p>
<h3>Reboot</h3>
<p>Finally a quick reboot to make sure it mounts correctly on boot, there's no reason it shouldn't but better to be safe than sorry.</p>
<div class="highlight"><pre><span></span><code>sudo reboot
</code></pre></div>

<p>And everything is there as expected. Success!</p>
<div class="highlight"><pre><span></span><code>$ ll /home
total 22
drwxr-xr-x  4 root root    4 Apr  6 12:40 ./
drwxr-xr-x 24 root root 4096 Apr  6 12:46 ../
drwx------  2 root root    2 Mar  4 17:42 lost+found/
drwxr-xr-x 46 ross ross   72 Apr  6 13:57 ross/
</code></pre></div>

<h3>Summary</h3>
<p>This process would have been a bit less painful if I'd use a LiveCD environment as I wouldn't have to have copies of copies of my home directory but overall it seems to have gone well.</p>
<p>I'm going to keep <code>/temp-home</code> around for a week or so just incase something goes wrong but once I'm happy everything is okay that will be deleted.</p>
<p>The next steps are to learn more about ZFS snapshots and replication so that I can start using these for my backups. I'm pretty new to ZFS and this is the first time I've created pools and file systems in this manor, my only previous experience was in TrueNAS which gives a nice web UI interface for performing all these tasks.</p>
<p>I've heard great things about <a href="https://github.com/jimsalterjrs/sanoid">sanoid</a> so I'm probably going to go with that for my snapshot and backup solution. I'll of course write a blog post about it but for now I'm just going to keep my <code>rsync</code> cronjob around for backups.</p>
<p>If you have any questions or suggestions for using ZFS please get in touch. Contact details be found <a href="https://rossw.co.uk/pages/about.html">here</a>.</p>
                <section>
                <p id="post-share-links">
                    Share on:
                    <a href="https://twitter.com/intent/tweet?text=Giving%20/home%20a%20new%20home%20on%20ZFS&url=https%3A//rossw.co.uk/home-to-zfs.html&hashtags=zfs,linux,ubuntu,sysadmin" title="Share on Twitter">Twitter</a>
                    ·
                    <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A//rossw.co.uk/home-to-zfs.html" title="Share on Facebook">Facebook</a>
                    ·
                    <a href="https://www.reddit.com/submit?url=https%3A//rossw.co.uk/home-to-zfs.html&title=Giving%20/home%20a%20new%20home%20on%20ZFS" title="Share via Reddit">Reddit</a>
                    ·
                    <a href="mailto:?subject=Giving%20/home%20a%20new%20home%20on%20ZFS&amp;body=https%3A//rossw.co.uk/home-to-zfs.html" title="Share via Email">Email</a>
                </p>
                </section>
                <div class="clear"></div>

                <div class="info">
                    <a href="https://rossw.co.uk/home-to-zfs.html">posted at 10:00</a>
                    &nbsp;&middot;&nbsp;<a href="https://rossw.co.uk/category/linux.html" rel="tag">Linux</a>
                    &nbsp;&middot;
                    &nbsp;<a href="https://rossw.co.uk/tag/zfs.html" class="tags">zfs</a>
                    &nbsp;<a href="https://rossw.co.uk/tag/linux.html" class="tags">linux</a>
                    &nbsp;<a href="https://rossw.co.uk/tag/ubuntu.html" class="tags">ubuntu</a>
                    &nbsp;<a href="https://rossw.co.uk/tag/sysadmin.html" class="tags">sysadmin</a>
                </div>
            </article>            <h4 class="date">Apr 04, 2021</h4>

            <article class="post">
                <h2 class="title">
                    <a href="https://rossw.co.uk/blog-setup-part1-terraform.html" rel="bookmark" title="Permanent Link to &quot;Blog Setup - Part 1 - Provisioning with Terraform&quot;">Blog Setup - Part 1 - Provisioning with Terraform</a>
                </h2>

                
                

                <p>This is the first part of a mini series detailing how this blog was setup. In this part I will discuss provisioning using Terraform. The relevant files can be found in this github <a href="https://github.com/rosswf/rossw-blog-terraform">repo</a>.</p>
<p>I have used a single AWS EC2 instance running ubuntu for hosting the actual content and Cloudflare for my DNS. I know this is slightly overkill for serving static web content but it was partially done this way as a learning exercise and this size of instance is available in the free tier. Even after the free period it isn't that expensive.</p>
<p>The aim of this is to discuss the process of setting up this blog, it is not to provide a guide on how to setup/install Terraform and setup your AWS credentials, there are plenty of resources available elsewhere for this, including the Terraform documentation. That said, the files in the github repo can be used as boiler-plate for provisioning your own EC2 instance for hosting web content.
I do not pretend to be an expert on terraform as I'm still learning,I have tried to follow <a href="https://www.terraform-best-practices.com/">best practices</a> where possible but if anybody has any suggestions then please get in touch. 
Disclaimers aside, let's get into it!</p>
<h3>Preparation</h3>
<p>There is a little bit of preparation required before creating the actual resources. </p>
<p><span style="color: grey"><strong>backend.tf</strong></span></p>
<div class="highlight"><pre><span></span><code><span class="kd">terraform</span> <span class=" -Punctuation">{</span>
    <span class="kr">backend</span> <span class="s">&quot;s3&quot;</span> <span class=" -Punctuation">{</span>
<span class="na">        bucket</span>  <span class="o">=</span> <span class="s2">&quot;rossw-backend&quot;</span>
<span class="na">        key</span>     <span class="o">=</span> <span class="s2">&quot;rossw-blog.tfstate&quot;</span>
<span class="na">        region</span>  <span class="o">=</span> <span class="s2">&quot;eu-west-2&quot;</span>
    <span class=" -Punctuation">}</span>
<span class=" -Punctuation">}</span>
</code></pre></div>

<p>First of all we define a backend to store the state. It's a good idea to use an external source for this rather than storing it locally since if it is ever lost then terraform will have no idea what the state is and will end up creating resources again.
For this I have created an s3 bucket on AWS that we can simply point terraform to.</p>
<p><span style="color: grey"><strong>provider.tf</strong></span></p>
<div class="highlight"><pre><span></span><code><span class="kd">terraform</span> <span class=" -Punctuation">{</span>
    <span class="err">required_providers</span> <span class=" -Punctuation">{</span>
<span class="na">        cloudflare</span> <span class="o">=</span> <span class=" -Punctuation">{</span>
<span class="na">        source</span> <span class="o">=</span> <span class="s2">&quot;cloudflare/cloudflare&quot;</span>
<span class="na">        version</span> <span class="o">=</span> <span class="s2">&quot;~&gt; 2.0&quot;</span>
        <span class=" -Punctuation">}</span>
    <span class=" -Punctuation">}</span>
<span class=" -Punctuation">}</span>

<span class="kr">provider</span> <span class="s">&quot;aws&quot;</span> <span class=" -Punctuation">{</span>
<span class="na">    region</span> <span class="o">=</span> <span class="err">var</span><span class="p">.</span><span class="err">region</span>
<span class=" -Punctuation">}</span>

<span class="kr">provider</span> <span class="s">&quot;cloudflare&quot;</span> <span class=" -Punctuation">{</span>
<span class=" -Punctuation">}</span>
</code></pre></div>

<p>Next we define the providers, for this we will use both aws and cloudflare for automatically creating the appropriate DNS records since we won't know the IP address of the EC2 instance until it has been created.</p>
<p><span style="color: grey"><strong>output.tf</strong></span></p>
<div class="highlight"><pre><span></span><code><span class="kr">output</span> <span class="s">&quot;ip_address&quot;</span> <span class=" -Punctuation">{</span>
<span class="na">    value</span> <span class="o">=</span> <span class="err">aws_eip</span><span class="p">.</span><span class="err">server_ip</span><span class="p">.</span><span class="err">public_ip</span>
<span class=" -Punctuation">}</span>
</code></pre></div>

<p>As mentioned above we won't know the IP address until creation so let's define an output to easily access this. It will come in handy in the next part when we look at ansible.</p>
<p><span style="color: grey"><strong>variables.tf</strong></span></p>
<div class="highlight"><pre><span></span><code><span class="kr">variable</span> <span class="s">&quot;type&quot;</span> <span class=" -Punctuation">{</span>
<span class="na">    type</span> <span class="o">=</span> <span class="err">string</span>
<span class="na">    default</span> <span class="o">=</span> <span class="s2">&quot;t2.micro&quot;</span>
<span class=" -Punctuation">}</span>

<span class="kr">variable</span> <span class="s">&quot;region&quot;</span> <span class=" -Punctuation">{</span>
<span class="na">    type</span> <span class="o">=</span> <span class="err">string</span>
<span class="na">    default</span> <span class="o">=</span> <span class="s2">&quot;eu-west-2&quot;</span>
<span class=" -Punctuation">}</span>

<span class="kr">variable</span> <span class="s">&quot;number&quot;</span> <span class=" -Punctuation">{</span>
<span class="na">    type</span> <span class="o">=</span> <span class="err">string</span>
<span class="na">    default</span> <span class="o">=</span> <span class="s2">&quot;1&quot;</span>
<span class=" -Punctuation">}</span>

<span class="kr">variable</span> <span class="s">&quot;key_name&quot;</span> <span class=" -Punctuation">{</span>
<span class="na">    type</span> <span class="o">=</span> <span class="err">string</span>
<span class=" -Punctuation">}</span>

<span class="kr">variable</span> <span class="s">&quot;public_key&quot;</span> <span class=" -Punctuation">{</span>
<span class="na">    type</span> <span class="o">=</span> <span class="err">string</span>
<span class=" -Punctuation">}</span>

<span class="kr">variable</span> <span class="s">&quot;zone_id&quot;</span> <span class=" -Punctuation">{</span>
<span class="na">    type</span> <span class="o">=</span> <span class="err">string</span>
<span class=" -Punctuation">}</span>

<span class="kr">variable</span> <span class="s">&quot;my_public_ip&quot;</span> <span class=" -Punctuation">{</span>
<span class="na">    type</span> <span class="o">=</span> <span class="err">string</span>
<span class=" -Punctuation">}</span>
</code></pre></div>

<p><span style="color: grey"><strong>terraform.tfvars</strong></span></p>
<div class="highlight"><pre><span></span><code><span class="na">type</span> <span class="o">=</span> <span class="s2">&quot;t2.micro&quot;</span>
<span class="na">region</span> <span class="o">=</span> <span class="s2">&quot;eu-west-2&quot;</span>
<span class="na">number</span> <span class="o">=</span> <span class="s2">&quot;1&quot;</span>
<span class="na">key_name</span> <span class="o">=</span> <span class="s2">&quot;rossw-key&quot;</span>
</code></pre></div>

<p>Finally let's define our variables and set values for some of them in terraform.tfvars.</p>
<p><span style="color: grey"><strong>vars.sh</strong></span></p>
<div class="highlight"><pre><span></span><code><span class="nb">export</span> <span class="nv">CLOUDFLARE_API_KEY</span><span class="o">=</span><span class="s1">&#39;your_cloudflare_api_key&#39;</span>
<span class="nb">export</span> <span class="nv">CLOUDFLARE_ACCOUNT_ID</span><span class="o">=</span><span class="s1">&#39;your_cloudflare_account_id&#39;</span>
<span class="nb">export</span> <span class="nv">CLOUDFLARE_EMAIL</span><span class="o">=</span><span class="s1">&#39;your_cloudflare_email&#39;</span>
<span class="nb">export</span> <span class="nv">TF_VAR_zone_id</span><span class="o">=</span><span class="s1">&#39;your_cloudflare_zone_id&#39;</span>
<span class="nb">export</span> <span class="nv">TF_VAR_public_key</span><span class="o">=</span><span class="s1">&#39;your_public_ssh_key&#39;</span>
<span class="nb">export</span> <span class="nv">TF_VAR_my_public_ip</span><span class="o">=</span><span class="s1">&#39;your_public_ip_at_home&#39;</span>
</code></pre></div>

<p>The remaining variables are secret so will be set as environment variables. To make this easier I've created a bash script that I can run prior to terraform but you can set them up however you'd like.</p>
<h3>Resources</h3>
<p>Now that everything is setup. Let's define our resources.</p>
<p><span style="color: grey"><strong>main.tf</strong></span></p>
<div class="highlight"><pre><span></span><code><span class="kr">resource</span> <span class="s">&quot;aws_instance&quot; &quot;blog_web_server&quot;</span> <span class=" -Punctuation">{</span>
<span class="na">    ami</span>             <span class="o">=</span> <span class="s2">&quot;ami-096cb92bb3580c759&quot;</span>
<span class="na">    instance_type</span>   <span class="o">=</span> <span class="err">var</span><span class="p">.</span><span class="err">type</span>
<span class="na">    key_name</span>        <span class="o">=</span> <span class="err">var</span><span class="p">.</span><span class="err">key_name</span>
<span class="na">    vpc_security_group_ids</span> <span class="o">=</span> <span class="p">[</span><span class="err">aws_security_group</span><span class="p">.</span><span class="err">blog_security_group</span><span class="p">.</span><span class="err">id</span><span class="p">]</span>

<span class="na">    tags</span> <span class="o">=</span> <span class=" -Punctuation">{</span>
<span class="na">        Name</span> <span class="o">=</span> <span class="s2">&quot;Blog Web Server&quot;</span>
    <span class=" -Punctuation">}</span> 
<span class=" -Punctuation">}</span>

<span class="kr">resource</span> <span class="s">&quot;aws_key_pair&quot; &quot;blog_key&quot;</span> <span class=" -Punctuation">{</span>
<span class="na">    key_name</span>        <span class="o">=</span> <span class="err">var</span><span class="p">.</span><span class="err">key_name</span>
<span class="na">    public_key</span>      <span class="o">=</span> <span class="err">var</span><span class="p">.</span><span class="err">public_key</span>
<span class=" -Punctuation">}</span>

<span class="kr">resource</span> <span class="s">&quot;aws_security_group&quot; &quot;blog_security_group&quot;</span> <span class=" -Punctuation">{</span>
<span class="na">    name</span>            <span class="o">=</span> <span class="s2">&quot;Blog Web Server&quot;</span>
<span class="na">    description</span>     <span class="o">=</span> <span class="s2">&quot;Allow web and local SSH&quot;</span>

    <span class="kd">ingress</span> <span class=" -Punctuation">{</span>
<span class="na">        from_port</span>   <span class="o">=</span> <span class="m">80</span>
<span class="na">        to_port</span>     <span class="o">=</span> <span class="m">80</span>
<span class="na">        protocol</span>    <span class="o">=</span> <span class="s2">&quot;tcp&quot;</span>
<span class="na">        cidr_blocks</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;0.0.0.0/0&quot;</span><span class="p">]</span>
    <span class=" -Punctuation">}</span>

    <span class="kd">ingress</span> <span class=" -Punctuation">{</span>
<span class="na">        from_port</span>   <span class="o">=</span> <span class="m">443</span>
<span class="na">        to_port</span>     <span class="o">=</span> <span class="m">443</span>
<span class="na">        protocol</span>    <span class="o">=</span> <span class="s2">&quot;tcp&quot;</span>
<span class="na">        cidr_blocks</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;0.0.0.0/0&quot;</span><span class="p">]</span>
    <span class=" -Punctuation">}</span>

    <span class="kd">ingress</span> <span class=" -Punctuation">{</span>
<span class="na">        from_port</span>   <span class="o">=</span> <span class="m">22</span>
<span class="na">        to_port</span>     <span class="o">=</span> <span class="m">22</span>
<span class="na">        protocol</span>    <span class="o">=</span> <span class="s2">&quot;tcp&quot;</span>
<span class="na">        cidr_blocks</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;${var.my_public_ip}/32&quot;</span><span class="p">]</span>
    <span class=" -Punctuation">}</span>

    <span class="kd">egress</span> <span class=" -Punctuation">{</span>
<span class="na">        from_port</span>   <span class="o">=</span> <span class="m">0</span>
<span class="na">        to_port</span>     <span class="o">=</span> <span class="m">0</span>
<span class="na">        protocol</span>    <span class="o">=</span> <span class="s2">&quot;-1&quot;</span>
<span class="na">        cidr_blocks</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;0.0.0.0/0&quot;</span><span class="p">]</span>
    <span class=" -Punctuation">}</span>
<span class=" -Punctuation">}</span>

<span class="kr">resource</span> <span class="s">&quot;aws_eip&quot; &quot;server_ip&quot;</span> <span class=" -Punctuation">{</span>
<span class="na">    vpc</span> <span class="o">=</span> <span class="kt">true</span>
<span class="na">    instance</span> <span class="o">=</span> <span class="err">aws_instance</span><span class="p">.</span><span class="err">blog_web_server</span><span class="p">.</span><span class="err">id</span>
<span class=" -Punctuation">}</span>

<span class="kr">resource</span> <span class="s">&quot;cloudflare_record&quot; &quot;blog_root&quot;</span> <span class=" -Punctuation">{</span>
<span class="na">    zone_id</span>     <span class="o">=</span> <span class="err">var</span><span class="p">.</span><span class="err">zone_id</span>
<span class="na">    name</span>        <span class="o">=</span> <span class="s2">&quot;@&quot;</span>
<span class="na">    value</span>       <span class="o">=</span> <span class="err">aws_eip</span><span class="p">.</span><span class="err">server_ip</span><span class="p">.</span><span class="err">public_ip</span>
<span class="na">    type</span>        <span class="o">=</span> <span class="s2">&quot;A&quot;</span>
<span class="na">    ttl</span>         <span class="o">=</span> <span class="m">1</span>
<span class="na">    proxied</span>     <span class="o">=</span> <span class="kt">true</span>

<span class="na">    depends_on</span> <span class="o">=</span> <span class="p">[</span>
        <span class="err">aws_eip</span><span class="p">.</span><span class="err">server_ip</span><span class="p">,</span>
    <span class="p">]</span>
<span class=" -Punctuation">}</span>

<span class="kr">resource</span> <span class="s">&quot;cloudflare_record&quot; &quot;blog_www&quot;</span> <span class=" -Punctuation">{</span>
<span class="na">    zone_id</span>     <span class="o">=</span> <span class="err">var</span><span class="p">.</span><span class="err">zone_id</span>
<span class="na">    name</span>        <span class="o">=</span> <span class="s2">&quot;www&quot;</span>
<span class="na">    value</span>       <span class="o">=</span> <span class="err">aws_eip</span><span class="p">.</span><span class="err">server_ip</span><span class="p">.</span><span class="err">public_ip</span>
<span class="na">    type</span>        <span class="o">=</span> <span class="s2">&quot;A&quot;</span>
<span class="na">    ttl</span>         <span class="o">=</span> <span class="m">1</span>
<span class="na">    proxied</span>     <span class="o">=</span> <span class="kt">true</span>

<span class="na">    depends_on</span> <span class="o">=</span> <span class="p">[</span>
        <span class="err">aws_eip</span><span class="p">.</span><span class="err">server_ip</span><span class="p">,</span>
    <span class="p">]</span>
<span class=" -Punctuation">}</span>
</code></pre></div>

<p>Here we have:</p>
<ul>
<li>The EC2 instance, that will use the ubuntu 20.04 image.</li>
<li>A key pair using our public ssh key defined earlier, this is used to access the instance via SSH.</li>
<li>A security group. Port 80 and 443 are open to the world for serving the web content, while port 22 will only be accessible from our local machine, using the ip defined in the <code>TF_VAR_my_public_up</code> environment variable. Connections from any other IP address will be denied.</li>
<li>An elastic IP for associating with your EC2 instance, that way if the instance goes down or we have to destroy it and create a new one the IP address won't change</li>
<li>Cloudflare DNS records using the public IP address that gets given to the instance.</li>
</ul>
<h3>Final Steps</h3>
<p>A quick holy trinity of <code>terraform init</code>, <code>terraform plan</code>, <code>terraform apply</code> and we have a fully provisioned EC2 instance only allowing the connections we want and DNS records pointing to the instance! </p>
<p><img alt="AWS Console" src="https://rossw.co.uk/images/part1-aws-console.webp"></p>
<p>That's it for part1. In the next I will discuss configuring the server using ansible.</p>
<p>If you have any questions or would like me to go into more detail on anything discussed here please get in touch on twitter or e-mail me. Contact details be found <a href="https://rossw.co.uk/pages/about.html">here</a>.</p>
                <section>
                <p id="post-share-links">
                    Share on:
                    <a href="https://twitter.com/intent/tweet?text=Blog%20Setup%20-%20Part%201%20-%20Provisioning%20with%20Terraform&url=https%3A//rossw.co.uk/blog-setup-part1-terraform.html&hashtags=blog,meta,terraform" title="Share on Twitter">Twitter</a>
                    ·
                    <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A//rossw.co.uk/blog-setup-part1-terraform.html" title="Share on Facebook">Facebook</a>
                    ·
                    <a href="https://www.reddit.com/submit?url=https%3A//rossw.co.uk/blog-setup-part1-terraform.html&title=Blog%20Setup%20-%20Part%201%20-%20Provisioning%20with%20Terraform" title="Share via Reddit">Reddit</a>
                    ·
                    <a href="mailto:?subject=Blog%20Setup%20-%20Part%201%20-%20Provisioning%20with%20Terraform&amp;body=https%3A//rossw.co.uk/blog-setup-part1-terraform.html" title="Share via Email">Email</a>
                </p>
                </section>
                <div class="clear"></div>

                <div class="info">
                    <a href="https://rossw.co.uk/blog-setup-part1-terraform.html">posted at 11:22</a>
                    &nbsp;&middot;&nbsp;<a href="https://rossw.co.uk/category/terraform.html" rel="tag">Terraform</a>
                    &nbsp;&middot;
                    &nbsp;<a href="https://rossw.co.uk/tag/blog.html" class="tags">blog</a>
                    &nbsp;<a href="https://rossw.co.uk/tag/meta.html" class="tags">meta</a>
                    &nbsp;<a href="https://rossw.co.uk/tag/terraform.html" class="tags">terraform</a>
                </div>
            </article>            <h4 class="date">Apr 02, 2021</h4>

            <article class="post">
                <h2 class="title">
                    <a href="https://rossw.co.uk/first-post.html" rel="bookmark" title="Permanent Link to &quot;First Post&quot;">First Post</a>
                </h2>

                
                

                <p>Welcome!</p>
<p>I recently started taking my hobby of tinkering with (and breaking) technology a lot more seriously and have decided to write about my experiences.</p>
<p>I'll be writing about any projects that I'm working on and technology that interests me. 
The plan is to start with two or three posts about how I definitely didn't go overkill with the hosting of this blog... You'll have to keep reading to find out more but it involves AWS, terraform and ansible.</p>
<p>In the meantime, please check out my <a href="https://twitter.com/rossw_">twitter</a> and <a href="https://github.com/rosswf">github</a>.</p>
                <section>
                <p id="post-share-links">
                    Share on:
                    <a href="https://twitter.com/intent/tweet?text=First%20Post&url=https%3A//rossw.co.uk/first-post.html&hashtags=blog,meta" title="Share on Twitter">Twitter</a>
                    ·
                    <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A//rossw.co.uk/first-post.html" title="Share on Facebook">Facebook</a>
                    ·
                    <a href="https://www.reddit.com/submit?url=https%3A//rossw.co.uk/first-post.html&title=First%20Post" title="Share via Reddit">Reddit</a>
                    ·
                    <a href="mailto:?subject=First%20Post&amp;body=https%3A//rossw.co.uk/first-post.html" title="Share via Email">Email</a>
                </p>
                </section>
                <div class="clear"></div>

                <div class="info">
                    <a href="https://rossw.co.uk/first-post.html">posted at 19:12</a>
                    &nbsp;&middot;&nbsp;<a href="https://rossw.co.uk/category/meta.html" rel="tag">Meta</a>
                    &nbsp;&middot;
                    &nbsp;<a href="https://rossw.co.uk/tag/blog.html" class="tags">blog</a>
                    &nbsp;<a href="https://rossw.co.uk/tag/meta.html" class="tags">meta</a>
                </div>
            </article>

                <div class="clear"></div>
                <div class="pages">

                    <a href="https://rossw.co.uk/index.html" class="prev_page">&larr;&nbsp;Previous</a>


                    <span>Page 2 of 2</span>
                </div>

            <div class="clear"></div>
            <footer>
                <p>
                <a href="https://github.com/rosswf"><img src="https://rossw.co.uk/theme/images/GitHub-Mark-32px.webp" alt="My Github" width="32" height="32"></a>
                <a href="https://twitter.com/rossw_"><img src="https://rossw.co.uk/theme/images/2021-Twitter-logo-black.webp" alt="My Twitter" width="32" height="26"></a>
                </p>
                <p>
                Modified <a href="https://github.com/jody-frankowski/blue-penguin">Blue Penguin</a> Theme
                &middot;
                Powered by <a href="http://getpelican.com">Pelican</a>
                &middot;
                <a href="https://rossw.co.uk/feeds/all.rss.xml" rel="alternate">Rss Feed</a>
            </footer>
        </div>
        <div class="clear"></div>
    </div>
    <a href="https://github.com/rosswf" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#15A9DB; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>
</body>
</html>